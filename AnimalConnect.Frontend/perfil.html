<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Animal Connect</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-white shadow-md mb-8">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="index.html" class="flex items-center text-gray-700 hover:text-orange-500 transition">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Volver al Inicio
                </a>
            </div>
            <h1 class="text-xl font-bold text-orange-600">Mi Panel de Gesti√≥n</h1>
            <div class="w-24"></div> </div>
    </nav>

    <div class="container mx-auto px-4">
        
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center text-orange-500 text-2xl mr-4">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold" id="user-name">Cargando...</h2>
                    <p class="text-gray-500 text-sm">Gestiona tus reportes y adopciones</p>
                </div>
            </div>
            <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition font-bold text-sm">
                <i class="fa-solid fa-power-off mr-2"></i> Cerrar Sesi√≥n
            </button>
        </div>

        <h3 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-orange-500 pl-3">Mis Publicaciones</h3>
        
        <div id="grid-mis-publicaciones" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-10">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gray-300"></i>
            </div>
        </div>

        <div id="sec-veterinario" class="hidden mt-12 pt-8 border-t border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-700 border-l-4 border-blue-500 pl-3">Mis Cl√≠nicas & Consultorios</h3>
                <a href="clinica-wizard.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 shadow-md transition flex items-center">
                    <i class="fa-solid fa-plus-circle mr-2"></i> Nueva Cl√≠nica
                </a>
            </div>
            
            <div id="grid-mis-clinicas" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="text-gray-400 text-sm italic">Cargando tus consultorios...</div>
            </div>
        </div>

        <div class="mt-8 pt-8 border-t border-gray-200" id="sec-ongs-container"> <div class="bg-purple-50 p-6 rounded-xl border border-purple-100 flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 id="sec-ongs-title" class="text-lg font-bold text-purple-800">
                        <i class="fa-solid fa-users-rectangle mr-2"></i>Organizaciones y Refugios
                    </h3>
                    <p class="text-sm text-purple-600">¬øTienes un refugio? Reg√≠stralo para gestionar tr√°nsitos.</p>
                </div>
                <a href="ong-wizard.html" id="btn-crear-ong" class="bg-purple-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-purple-700 shadow-md transition">
                    Crear Organizaci√≥n
                </a>
            </div>
            <div id="mis-ongs-list" class="mt-4 space-y-2"></div>
        </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="bg-teal-50 p-6 rounded-xl border border-teal-100 flex flex-col md:flex-row justify-between items-center relative overflow-hidden">
                <i class="fa-solid fa-house-chimney-medical absolute -right-4 -bottom-4 text-8xl text-teal-100 opacity-50 pointer-events-none"></i>
                
                <div class="mb-4 md:mb-0 z-10">
                    <h3 class="text-lg font-bold text-teal-800 flex items-center">
                        <i class="fa-solid fa-hand-holding-heart mr-2"></i> Quiero ser Hogar de Tr√°nsito
                    </h3>
                    <p class="text-sm text-teal-600 max-w-md">Ofrece un espacio temporal en tu casa.</p>
                </div>
                
                <a href="hogar-wizard.html" id="btn-ofrecer-hogar" class="z-10 bg-teal-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-teal-700 shadow-md transition flex items-center">
                    <i class="fa-solid fa-plus-circle mr-2"></i> Ofrecer mi Hogar
                </a>
            </div>

            
        </div>

        <div id="sec-comercio" class="hidden mt-12 pt-8 border-t border-gray-200 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-700 border-l-4 border-orange-500 pl-3">Mis Comercios</h3>
                <a href="comercio-wizard.html" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-orange-700 shadow-md transition flex items-center">
                    <i class="fa-solid fa-plus-circle mr-2"></i> Nuevo Comercio
                </a>
            </div>
            
            <div id="grid-mis-comercios" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="text-gray-400 text-sm italic">Cargando tus tiendas...</div>
            </div>
        </div>
</div>

    </div>

    <div id="modal-catalogo" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" onclick="cerrarModalCatalogo()"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-lg border border-gray-200">
                
                <div class="bg-orange-50 px-6 py-4 border-b border-orange-100 flex justify-between items-center">
                    <h3 class="font-bold text-orange-800 text-lg">Administrar Cat√°logo</h3>
                    <button onclick="cerrarModalCatalogo()" class="text-orange-400 hover:text-orange-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <div class="p-6">
                    <form id="form-producto" class="mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <h4 class="text-sm font-bold text-gray-700 mb-3"><i class="fa-solid fa-plus mr-1"></i> Agregar Nuevo Producto</h4>
                        <input type="hidden" id="prod-comercio-id">
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input type="text" id="prod-nombre" placeholder="Nombre (Ej: Correa)" class="border rounded-lg p-2 text-sm w-full outline-none focus:border-orange-500" required>
                            <input type="number" id="prod-precio" placeholder="Precio ($)" class="border rounded-lg p-2 text-sm w-full outline-none focus:border-orange-500">
                        </div>
                        <input type="text" id="prod-desc" placeholder="Descripci√≥n breve..." class="border rounded-lg p-2 text-sm w-full mb-3 outline-none focus:border-orange-500">
                        <input type="url" id="prod-img" placeholder="URL Imagen (https://...)" class="border rounded-lg p-2 text-sm w-full mb-3 outline-none focus:border-orange-500">
                        
                        <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg text-sm transition">
                            Guardar Producto
                        </button>
                    </form>

                    <div class="border-t border-gray-100 my-4"></div>

                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Productos Activos</h4>
                    <div id="lista-productos-modal" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                        </div>
                </div>

            </div>
        </div>
    </div>
</div>

   <script>
        const API_URL = 'http://127.0.0.1:5269/api';
        const usuario = JSON.parse(localStorage.getItem('zoonosis_user'));

       document.addEventListener('DOMContentLoaded', async () => {
            if(!usuario) { window.location.href = 'login.html'; return; }
            
            // 1. Cargar Header Usuario
            const htmlPuntos = usuario.puntos ? `<span class="ml-2 text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full"><i class="fa-solid fa-trophy text-yellow-500 mr-1"></i>${usuario.puntos} Ptos</span>` : '';
            document.getElementById('user-name').innerHTML = `${usuario.nombre} ${htmlPuntos}`;

            // 2. Cargar datos b√°sicos
            cargarMisPublicaciones();

            cargarMisComercios();
            
            if (usuario.rol === 'Veterinario') {
                document.getElementById('sec-veterinario').classList.remove('hidden');
                cargarMisClinicas();
            }

            // 3. VERIFICAR ESTADOS (NUEVO)
            await verificarEstadoHogar();
            await verificarEstadoOng();
        });

        // --- L√ìGICA DE ESTADOS ---

    async function verificarEstadoOng() {
        try {
            // Consultamos si tiene ONGs vinculadas
            const res = await fetch(`${API_URL}/Organizaciones/mis-ongs/${usuario.id}`);
            if (res.ok) {
                const lista = await res.json();
                const ongUsuario = lista.length > 0 ? lista[0] : null; // Asumimos 1 por ahora
                
                const container = document.querySelector('#sec-ongs-container'); // Necesitamos darle ID al div padre en el HTML
                const btnCrear = document.getElementById('btn-crear-ong'); // Necesitamos darle ID al bot√≥n en el HTML

                if (ongUsuario) {
                    if (ongUsuario.estadoVerificacion === 'Pendiente') {
                        // CASO 1: PENDIENTE
                        btnCrear.outerHTML = `
                            <button disabled class="bg-yellow-100 text-yellow-700 px-5 py-2 rounded-lg font-bold border border-yellow-300 cursor-not-allowed flex items-center">
                                <i class="fa-solid fa-clock mr-2"></i> Verificaci√≥n Pendiente
                            </button>`;
                    } else if (ongUsuario.estadoVerificacion === 'Aprobado') {
                        // CASO 2: APROBADO (Bot√≥n de Acceso)
                        btnCrear.outerHTML = `
                            <a href="panel-ong.html" class="bg-purple-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-purple-700 shadow-md transition flex items-center">
                                <i class="fa-solid fa-chart-pie mr-2"></i> Ir al Panel de Gesti√≥n
                            </a>`;
                        
                        // Mostrar nombre de la ONG
                        const titulo = document.querySelector('#sec-ongs-title'); // Darle ID al h3
                        if(titulo) titulo.innerHTML += ` <span class="text-sm font-normal text-gray-500">(${ongUsuario.nombre})</span>`;
                    }
                }
            }
        } catch (e) { console.error("Error verificando ONG", e); }
    }

    async function verificarEstadoHogar() {
        try {
            const res = await fetch(`${API_URL}/Hogares/mi-hogar/${usuario.id}`);
            const btnHogar = document.getElementById('btn-ofrecer-hogar'); 

            if (res.ok) {
                const hogar = await res.json();
                
                // Calculamos d√≠as desde √∫ltima actualizaci√≥n
                const fechaAct = new Date(hogar.ultimaActualizacion);
                const hoy = new Date();
                const diffTime = Math.abs(hoy - fechaAct);
                const diasPasados = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diasRestantes = 30 - diasPasados;

                let contenidoHtml = '';

                // L√≥gica de "Sem√°foro" y Bot√≥n Reactivar
                if (diasPasados >= 30) {
                    // --- VENCIDO (ROJO) ---
                    contenidoHtml = `
                        <div class="flex flex-col sm:flex-row gap-3 w-full">
                            <button onclick="renovarHogar(${hogar.id})" class="flex-1 bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold border border-red-200 hover:bg-red-100 transition animate-pulse text-sm">
                                <i class="fa-solid fa-triangle-exclamation mr-2"></i> Publicaci√≥n Pausada (Reactivar)
                            </button>
                            ${generarBotonesGestion(hogar.id)}
                        </div>`;
                } else if (diasPasados >= 25) {
                    // --- POR VENCER (AMARILLO) - Mostramos bot√≥n renovar preventivo ---
                    contenidoHtml = `
                        <div class="flex flex-col sm:flex-row gap-3 w-full">
                            <button onclick="renovarHogar(${hogar.id})" class="flex-1 bg-yellow-50 text-yellow-700 px-4 py-2 rounded-lg font-bold border border-yellow-200 hover:bg-yellow-100 transition text-sm">
                                <i class="fa-solid fa-clock mr-2"></i> Renovar (Vence en ${diasRestantes} d√≠as)
                            </button>
                            ${generarBotonesGestion(hogar.id)}
                        </div>`;
                } else {
                    // --- ACTIVO (VERDE) ---
                    contenidoHtml = `
                        <div class="flex flex-col sm:flex-row gap-3 w-full items-center justify-between">
                            <span class="text-teal-700 font-bold text-sm bg-teal-50 px-3 py-1 rounded border border-teal-100">
                                <i class="fa-solid fa-check-circle mr-1"></i> Activo (${diasRestantes} d√≠as)
                            </span>
                            ${generarBotonesGestion(hogar.id)}
                        </div>`;
                }

                btnHogar.outerHTML = contenidoHtml;
            }
        } catch (e) { console.error("Error verificando Hogar", e); }
    }

    // Funci√≥n auxiliar para no repetir c√≥digo de botones Editar/Eliminar
    function generarBotonesGestion(id) {
        return `
            <div class="flex gap-2">
                <a href="hogar-wizard.html?editar=true" class="bg-white text-gray-600 border border-gray-300 px-3 py-2 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition shadow-sm" title="Editar datos">
                    <i class="fa-solid fa-pen"></i>
                </a>
                <button onclick="darBajaHogar(${id})" class="..." title="Eliminar Hogar">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;
    }

    // L√≥gica de renovaci√≥n
    async function renovarHogar(id) {
        const btn = event.target.closest('button');
        const icono = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
        
        try {
            const res = await fetch(`${API_URL}/Hogares/renovar/${id}`, { method: 'PUT' });
            if(res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: '¬°Publicaci√≥n Renovada!',
                    text: 'Tu hogar estar√° visible por 30 d√≠as m√°s.',
                    timer: 2000,
                    showConfirmButton: false
                });
                setTimeout(() => location.reload(), 2000);
            }
        } catch(e) { 
            console.error(e);
            btn.innerHTML = icono; 
        }
    }

    // --- ESTA ES PARA ELIMINAR COMERCIOS ---
        async function eliminarComercio(id) {
            const result = await Swal.fire({
                title: '¬øEliminar Comercio?',
                text: "Se borrar√° la tienda y todos sus productos. No se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(`${API_URL}/Comercios/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        Swal.fire('Eliminado', 'El comercio ha sido borrado.', 'success');
                        cargarMisComercios(); // Recargamos la lista correcta
                    } else {
                        Swal.fire('Error', 'No se pudo eliminar.', 'error');
                    }
                } catch (e) { console.error(e); }
            }
        }

        // --- ESTA ES PARA ELIMINAR HOGARES (RESTAURADA) ---
        async function darBajaHogar(id) {
            const result = await Swal.fire({
                title: '¬øEliminar Hogar?',
                text: "Dejar√°s de aparecer en las b√∫squedas.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9ca3af',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(`${API_URL}/Hogares/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        Swal.fire('Eliminado', 'Tu hogar ha sido dado de baja.', 'success')
                            .then(() => location.reload());
                    }
                } catch(e) { console.error(e); }
            }
        }

        function logout() {
            localStorage.removeItem('zoonosis_user');
            window.location.href = 'index.html';
        }

        async function cargarMisPublicaciones() {
            const grid = document.getElementById('grid-mis-publicaciones');
            // Spinner de carga
            grid.innerHTML = '<div class="col-span-full text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-orange-300"></i><p class="text-gray-500 mt-2">Cargando tus avisos...</p></div>';

            try {
                const res = await fetch(`${API_URL}/Animales/usuario/${usuario.id}`);
                if (!res.ok) throw new Error("Error API");
                const lista = await res.json();
                renderizarLista(lista);
            } catch (error) {
                console.error(error);
                grid.innerHTML = '<p class="col-span-full text-center text-red-500">No se pudieron cargar tus publicaciones.</p>';
            }
        }

        function renderizarLista(lista) {
            const grid = document.getElementById('grid-mis-publicaciones');
            grid.innerHTML = ''; // Limpiar spinner

            if(lista.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-white rounded-xl shadow border border-dashed border-gray-300">
                        <i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">No tienes publicaciones activas.</p>
                        <a href="index.html" class="mt-4 inline-block text-orange-600 font-bold hover:underline">Crear un reporte ahora</a>
                    </div>`;
                return;
            }

            lista.forEach(a => {
                const fechaRenov = new Date(a.fechaUltimaRenovacion);
                const hoy = new Date();
                const diasRestantes = 15 - Math.ceil(Math.abs(hoy - fechaRenov) / (1000 * 60 * 60 * 24));
                
                let estadoBadge = '';
                let acciones = '';
                let opacidad = 'opacity-100';

                // --- ESTADO 4: FINALIZADO (HIST√ìRICO) ---
                if (a.idEstado === 4) { 
                    opacidad = 'opacity-60 grayscale';
                    estadoBadge = `<span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold border border-gray-200">üèÅ CASO CERRADO</span>`;
                    acciones = `<button onclick="borrar(${a.id})" class="text-red-500 hover:text-red-700 font-bold text-sm w-full text-center py-2"><i class="fa-solid fa-trash-can mr-2"></i>Eliminar del historial</button>`;
                } 
                // --- ESTADO 2: PERDIDO ---
                else if (a.idEstado === 2) {
                    estadoBadge = `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-200">üî¥ SE BUSCA</span>`;
                    acciones = `
                        <button onclick="finalizar(${a.id}, 2)" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 mb-2 transition shadow-sm">
                            <i class="fa-solid fa-house-user mr-2"></i> ¬°Ya apareci√≥!
                        </button>
                        <div class="flex gap-2">
                            <button onclick="renovar(${a.id})" class="flex-1 bg-orange-50 text-orange-600 py-2 rounded-lg font-bold text-xs hover:bg-orange-100">Renovar (${diasRestantes}d)</button>
                            <button onclick="borrar(${a.id})" class="flex-1 border border-red-200 text-red-500 py-2 rounded-lg font-bold text-xs hover:bg-red-50">Borrar</button>
                        </div>
                    `;
                }
                // --- ESTADO 3: ENCONTRADO (AVISO) ---
                else if (a.idEstado === 3) {
                    estadoBadge = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">üü¢ BUSCO DUE√ëO</span>`;
                    acciones = `
                        <button onclick="finalizar(${a.id}, 3)" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 mb-2 transition shadow-sm">
                            <i class="fa-solid fa-handshake mr-2"></i> Entregado a familia
                        </button>
                        <div class="flex gap-2">
                            <button onclick="renovar(${a.id})" class="flex-1 bg-orange-50 text-orange-600 py-2 rounded-lg font-bold text-xs hover:bg-orange-100">Renovar (${diasRestantes}d)</button>
                            <button onclick="borrar(${a.id})" class="flex-1 border border-red-200 text-red-500 py-2 rounded-lg font-bold text-xs hover:bg-red-50">Borrar</button>
                        </div>
                    `;
                }
                // --- ESTADO 1: ADOPCI√ìN ---
                else {
                    estadoBadge = `<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">üè° EN ADOPCI√ìN</span>`;
                    acciones = `
                        <button onclick="finalizar(${a.id}, 1)" class="w-full bg-blue-500 text-white py-2 rounded-lg font-bold hover:bg-blue-600 mb-2 transition shadow-sm">
                            <i class="fa-solid fa-check mr-2"></i> ¬°Adoptado!
                        </button>
                        <button onclick="borrar(${a.id})" class="w-full border border-red-200 text-red-500 py-2 rounded-lg font-bold hover:bg-red-50 transition text-sm">Eliminar</button>
                    `;
                }

                grid.innerHTML += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col ${opacidad} transition-all hover:shadow-md">
                        <div class="relative h-48 group">
                            <img src="${a.imagenUrl || 'https://via.placeholder.com/400'}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                            <div class="absolute top-3 right-3 shadow-sm">${estadoBadge}</div>
                        </div>
                        <div class="p-5 flex-1 flex flex-col">
                            <h3 class="text-lg font-bold text-gray-800 mb-1">${a.nombre}</h3>
                            <p class="text-xs text-gray-500 mb-3 flex items-center">
                                <i class="fa-regular fa-calendar mr-1"></i> ${new Date(a.fechaPublicacion).toLocaleDateString()}
                            </p>
                            <p class="text-sm text-gray-600 mb-4 flex-1 line-clamp-2">${a.descripcion}</p>
                            
                            <div class="mt-auto border-t border-gray-100 pt-4">
                                ${acciones}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ... (Aqu√≠ van tus funciones finalizar, renovar y borrar que ya ten√≠as) ...
        async function finalizar(id, estadoOrigen) {
            const nuevoEstado = 4; // Finalizado
            
            let tituloConfirm = "¬øCaso Resuelto?";
            let textoConfirm = "";
            
            // Variables para pre-llenar el post en comunidad
            let tituloHistoria = "";
            let textoHistoria = "";

            if (estadoOrigen === 2) { 
                // PERDIDO -> ENCONTRADO
                textoConfirm = "¬°Qu√© alegr√≠a! Se marcar√° como encontrado.";
                tituloHistoria = "üéâ ¬°Final Feliz! Encontr√© a mi mascota";
                textoHistoria = "Gracias a todos los que compartieron, hoy tuvimos un reencuentro...";
            } else if (estadoOrigen === 3) {
                // ENCONTRADO -> DEVUELTO
                textoConfirm = "El aviso dejar√° de ser visible.";
                tituloHistoria = "üëè Misi√≥n Cumplida";
                textoHistoria = "Hoy esta mascota volvi√≥ con su familia...";
            } else {
                // ADOPCI√ìN -> ADOPTADO
                textoConfirm = "¬øSe concret√≥ la adopci√≥n?";
                tituloHistoria = "üè° ¬°Final Feliz! Se adopt√≥ una mascota üéâ"; // <--- EL TITULO QUE QUER√çAS
                textoHistoria = "Hoy celebramos que una nueva vida comienza...";
            }

            // 1. Confirmar Acci√≥n en Base de Datos
            const result = await Swal.fire({
                title: tituloConfirm,
                text: textoConfirm,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#22c55e',
                confirmButtonText: 'S√≠, confirmar'
            });

            if(!result.isConfirmed) return;

            try {
                const res = await fetch(`${API_URL}/Animales/estado/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(nuevoEstado)
                });
                
                if(res.ok) {
                    // 2. Preguntar si quiere compartir la historia
                    const shareResult = await Swal.fire({
                        title: '¬°Genial!',
                        text: '¬øTe gustar√≠a contar la historia en la Comunidad para sumar puntos?',
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonText: 'S√≠, compartir',
                        cancelButtonText: 'No, gracias'
                    });

                    if (shareResult.isConfirmed) {
                        // AQU√ç EST√Å LA SOLUCI√ìN: Pasamos los datos en la URL
                        // encodeURIComponent asegura que los emojis y espacios pasen bien
                        const url = `comunidad.html?modo=historia&titulo=${encodeURIComponent(tituloHistoria)}&texto=${encodeURIComponent(textoHistoria)}`;
                        window.location.href = url;
                    } else {
                        cargarMisPublicaciones(); // Solo recargar si no comparte
                    }
                }
            } catch(e) { console.error(e); }
        }

        async function renovar(id) {
            const result = await Swal.fire({
                title: '¬øRenovar publicaci√≥n?',
                text: "Tu aviso estar√° visible por 15 d√≠as m√°s.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316',
                confirmButtonText: 'S√≠, renovar'
            });

            if(result.isConfirmed) {
                await fetch(`${API_URL}/Animales/renovar/${id}`, { method: 'PUT' });
                Swal.fire('Renovado', 'Tu publicaci√≥n est√° activa nuevamente.', 'success');
                cargarMisPublicaciones();
            }
        }

        async function borrar(id) {
            const result = await Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "Esta acci√≥n eliminar√° el registro permanentemente.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if(result.isConfirmed) {
                await fetch(`${API_URL}/Animales/${id}`, { method: 'DELETE' });
                Swal.fire('Eliminado', 'El registro ha sido borrado.', 'success');
                cargarMisPublicaciones();
            }
        }

        async function borrar(id) {
            if(!confirm("¬øEliminar?")) return;
            await fetch(`${API_URL}/Animales/${id}`, { method: 'DELETE' });
            cargarMisPublicaciones();
        }

        async function cargarMisClinicas() {
            const contenedor = document.getElementById('grid-mis-clinicas');
            try {
                const res = await fetch(`${API_URL}/Clinicas/mis-clinicas/${usuario.id}`);
                if(res.ok) {
                    const lista = await res.json();
                    contenedor.innerHTML = '';
                    
                    if(lista.length === 0) {
                        contenedor.innerHTML = `
                            <div class="col-span-full text-center py-8 text-gray-500 bg-slate-50 rounded-xl border border-dashed border-gray-300">
                                <i class="fa-solid fa-house-medical text-4xl mb-2 text-gray-300"></i>
                                <p>A√∫n no has registrado ning√∫n consultorio.</p>
                            </div>`;
                        return;
                    }

                    lista.forEach(c => {
                        let infoTurno = '';
                        let btnClase = '';
                        let btnTexto = '';
                        let bordeCard = 'border-gray-200';

                        if (c.esDeTurno) {
                            // C√ÅLCULO DE TIEMPO RESTANTE
                            // Asumimos que c.fechaInicioTurno viene del backend (agregado en el paso 1)
                            // Si es null o undefined, usamos la hora actual como fallback visual
                            const fechaInicio = c.fechaInicioTurno ? new Date(c.fechaInicioTurno) : new Date();
                            const fechaFin = new Date(fechaInicio.getTime() + (24 * 60 * 60 * 1000));
                            const ahora = new Date();
                            
                            // Diferencia en horas
                            const diffMs = fechaFin - ahora;
                            const diffHrs = Math.ceil(diffMs / (1000 * 60 * 60));
                            
                            // Formateo de hora fin
                            const horaFinStr = fechaFin.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                            bordeCard = 'border-green-400 ring-2 ring-green-100';
                            infoTurno = `
                                <div class="mt-2 bg-green-50 text-green-800 text-xs px-3 py-2 rounded-lg border border-green-200 flex items-center justify-between">
                                    <span><i class="fa-solid fa-hourglass-half mr-1"></i> Quedan ${diffHrs}hs</span>
                                    <span class="font-bold">Fin: ${horaFinStr}hs</span>
                                </div>`;
                            
                            btnClase = 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100';
                            btnTexto = '<i class="fa-solid fa-power-off mr-1"></i> Finalizar Turno';
                        } else {
                            bordeCard = 'border-gray-200 hover:border-blue-300';
                            btnClase = 'bg-gray-50 text-gray-600 border-gray-300 hover:bg-green-50 hover:text-green-700 hover:border-green-300';
                            btnTexto = '<i class="fa-solid fa-toggle-off mr-1"></i> Poner de Turno';
                        }

                        contenedor.innerHTML += `
                            <div class="bg-white p-5 rounded-xl shadow-sm border ${bordeCard} transition-all duration-300 flex flex-col justify-between h-full">
                                <div>
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-gray-800 text-lg">${c.nombre}</h4>
                                        ${c.esDeTurno ? '<span class="animate-pulse bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide">En Vivo</span>' : ''}
                                    </div>
                                    
                                    <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-map-pin mr-1 text-gray-400"></i> ${c.direccion}</p>
                                    
                                    ${infoTurno}
                                </div>

                                <div class="mt-4 pt-4 border-t border-gray-100 flex gap-2">
                                    <button onclick="toggleTurno(${c.id}, ${c.esDeTurno})" class="flex-1 text-sm font-bold border px-3 py-2 rounded-lg transition-colors ${btnClase}">
                                        ${btnTexto}
                                    </button>
                                    <button class="w-10 bg-white border border-gray-200 text-gray-400 rounded-lg hover:text-blue-600 hover:border-blue-300 transition">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch(e) { console.error("Error cargando cl√≠nicas", e); }
        }

        async function toggleTurno(id, estadoActual) {
            if (!estadoActual) {
                // ACTIVAR TURNO
                const result = await Swal.fire({
                    title: '¬øActivar Guardia?',
                    html: `
                        <p class="text-sm text-gray-600 mb-4">Tu cl√≠nica aparecer√° destacada en el mapa como "De Turno".</p>
                        <div class="bg-blue-50 p-3 rounded-lg text-left text-sm text-blue-800 border border-blue-100">
                            <i class="fa-solid fa-circle-info mr-2"></i> <strong>Regla de 24hs:</strong>
                            <br>El estado se desactivar√° autom√°ticamente pasadas las 24 horas para mantener el mapa actualizado.
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#16a34a', // Green
                    cancelButtonColor: '#94a3b8',
                    confirmButtonText: 'S√≠, estoy de turno',
                    cancelButtonText: 'Cancelar'
                });

                if (!result.isConfirmed) return;

            } else {
                // DESACTIVAR TURNO
                const result = await Swal.fire({
                    title: '¬øFinalizar Guardia?',
                    text: "Dejar√°s de aparecer como urgencia en el mapa.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#94a3b8',
                    confirmButtonText: 'S√≠, finalizar',
                    cancelButtonText: 'Cancelar'
                });
                
                if (!result.isConfirmed) return;
            }

            // Llamada API
            try {
                const res = await fetch(`${API_URL}/Veterinarias/turno/${id}`, { method: 'PUT' });
                if(res.ok) {
                    const msg = estadoActual ? 'Guardia finalizada.' : '¬°Tu veterinaria est√° de turno!';
                    const icon = estadoActual ? 'info' : 'success';
                    
                    Swal.fire({
                        title: 'Actualizado',
                        text: msg,
                        icon: icon,
                        timer: 1500,
                        showConfirmButton: false
                    });
                    
                    cargarMisClinicas(); // Recargar UI
                }
            } catch(e) { console.error(e); }
        }


        // 1. Cargar "Mis Comercios" al iniciar
async function cargarMisComercios() {
    // Si no tienes l√≥gica de roles estricta, puedes llamar a esto siempre o verificar rol
    const contenedor = document.getElementById('grid-mis-comercios');
    const seccion = document.getElementById('sec-comercio');
    
    try {
        const res = await fetch(`${API_URL}/Comercios/mis-comercios/${usuario.id}`);
        if(res.ok) {
            const lista = await res.json();
            
            if(lista.length > 0) {
                seccion.classList.remove('hidden'); // Mostrar secci√≥n si tiene tiendas
                contenedor.innerHTML = '';

                lista.forEach(c => {
                    const cantProductos = c.catalogo ? c.catalogo.length : 0;
                    
                    contenedor.innerHTML += `
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-orange-300 transition flex flex-col justify-between">
                            <div class="flex items-start gap-4 mb-4">
                                <div class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center overflow-hidden border border-gray-100">
                                    ${c.logoUrl ? `<img src="${c.logoUrl}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-store text-gray-300 text-2xl"></i>'}
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg leading-tight">${c.nombre}</h4>
                                    <p class="text-xs text-gray-500 mt-1 line-clamp-1">${c.direccion}</p>
                                    <span class="inline-block mt-2 bg-orange-50 text-orange-700 text-xs font-bold px-2 py-1 rounded border border-orange-100">
                                        ${cantProductos} Productos
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 mt-auto">
                                <button onclick="abrirModalCatalogo(${c.id})" class="flex-1 bg-slate-800 text-white text-sm font-bold py-2 rounded-lg hover:bg-slate-700 transition shadow-sm">
                                    <i class="fa-solid fa-list-check mr-2"></i> Cat√°logo
                                </button>
                                <button onclick="eliminarComercio(${c.id})" class="w-10 flex items-center justify-center border border-gray-200 rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
        }
    } catch(e) { console.error("Error cargando comercios", e); }
}

// Llama a esta funci√≥n en el DOMContentLoaded
// document.addEventListener('DOMContentLoaded', async () => {
//    ...
//    cargarMisComercios(); // <--- AGREGAR ESTA LINEA
// });


// --- L√ìGICA DEL MODAL DE CAT√ÅLOGO ---

async function abrirModalCatalogo(comercioId) {
    document.getElementById('modal-catalogo').classList.remove('hidden');
    document.getElementById('prod-comercio-id').value = comercioId;
    
    // Cargar productos actuales
    cargarProductosModal(comercioId);
}

function cerrarModalCatalogo() {
    document.getElementById('modal-catalogo').classList.add('hidden');
    document.getElementById('form-producto').reset();
}

async function cargarProductosModal(comercioId) {
    const listaDiv = document.getElementById('lista-productos-modal');
    listaDiv.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-orange-400"></i></div>';

    try {
        // Reutilizamos el endpoint de detalle que ya trae el cat√°logo
        const res = await fetch(`${API_URL}/Comercios/${comercioId}`);
        if(res.ok) {
            const comercio = await res.json();
            const productos = comercio.catalogo || [];
            
            listaDiv.innerHTML = '';
            if(productos.length === 0) {
                listaDiv.innerHTML = '<p class="text-center text-xs text-gray-400 py-4">No hay productos cargados.</p>';
                return;
            }

            productos.forEach(p => {
                listaDiv.innerHTML += `
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-100 group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 bg-white rounded border border-gray-200 flex-shrink-0 overflow-hidden">
                                ${p.imagenUrl ? `<img src="${p.imagenUrl}" class="w-full h-full object-cover">` : ''}
                            </div>
                            <div class="min-w-0">
                                <p class="font-bold text-gray-700 text-sm truncate">${p.nombre}</p>
                                <p class="text-xs text-green-600 font-mono">$${p.precio}</p>
                            </div>
                        </div>
                        <button onclick="eliminarProducto(${p.id}, ${comercioId})" class="text-gray-300 hover:text-red-500 p-2 transition">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
            });
        }
    } catch(e) { console.error(e); }
}

// ALTA DE PRODUCTO
document.getElementById('form-producto').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    const originalText = btn.innerText;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
    btn.disabled = true;

    const comercioId = document.getElementById('prod-comercio-id').value;
    
    const productoDto = {
        comercioId: comercioId,
        nombre: document.getElementById('prod-nombre').value,
        precio: parseFloat(document.getElementById('prod-precio').value) || 0,
        descripcion: document.getElementById('prod-desc').value,
        imagenUrl: document.getElementById('prod-img').value
    };

    try {
        const res = await fetch(`${API_URL}/Comercios/producto`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(productoDto)
        });

        if(res.ok) {
            e.target.reset();
            cargarProductosModal(comercioId); // Recargar lista
            cargarMisComercios(); // Actualizar contador en tarjeta principal
            
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
            });
            Toast.fire({ icon: 'success', title: 'Producto agregado' });
        }
    } catch(err) { console.error(err); }
    
    btn.innerText = originalText;
    btn.disabled = false;
});

// BAJA DE PRODUCTO
async function eliminarProducto(id, comercioId) {
    if(!confirm("¬øBorrar este producto?")) return;

    try {
        const res = await fetch(`${API_URL}/Comercios/producto/${id}`, { method: 'DELETE' });
        if(res.ok) {
            cargarProductosModal(comercioId);
            cargarMisComercios();
        }
    } catch(e) { console.error(e); }
}
    </script>
</body>
</html>