<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Animal Connect</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-white shadow-md mb-8">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="index.html" class="flex items-center text-gray-700 hover:text-orange-500 transition">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Volver al Inicio
                </a>
            </div>
            <h1 class="text-xl font-bold text-orange-600">Mi Panel de Gesti√≥n</h1>
            <div class="w-24"></div> </div>
    </nav>

    <div class="container mx-auto px-4">
        
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center text-orange-500 text-2xl mr-4">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold" id="user-name">Cargando...</h2>
                    <p class="text-gray-500 text-sm">Gestiona tus reportes y adopciones</p>
                </div>
            </div>
            <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition font-bold text-sm">
                <i class="fa-solid fa-power-off mr-2"></i> Cerrar Sesi√≥n
            </button>
        </div>

        <h3 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-orange-500 pl-3">Mis Publicaciones</h3>
        
        <div id="grid-mis-publicaciones" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-10">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gray-300"></i>
            </div>
        </div>

    </div>

   <script>
        const API_URL = 'http://127.0.0.1:5269/api';
        const usuario = JSON.parse(localStorage.getItem('zoonosis_user'));

        document.addEventListener('DOMContentLoaded', () => {
            if(!usuario) {
                window.location.href = 'login.html';
                return;
            }
            const htmlPuntos = usuario.puntos ? `<span class="ml-2 text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full"><i class="fa-solid fa-trophy text-yellow-500 mr-1"></i>${usuario.puntos} Ptos</span>` : '';
            document.getElementById('user-name').innerHTML = `${usuario.nombre} ${htmlPuntos}`;
            cargarMisPublicaciones();
        });

        function logout() {
            localStorage.removeItem('zoonosis_user');
            window.location.href = 'index.html';
        }

        async function cargarMisPublicaciones() {
            const grid = document.getElementById('grid-mis-publicaciones');
            // Spinner de carga
            grid.innerHTML = '<div class="col-span-full text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-orange-300"></i><p class="text-gray-500 mt-2">Cargando tus avisos...</p></div>';

            try {
                const res = await fetch(`${API_URL}/Animales/usuario/${usuario.id}`);
                if (!res.ok) throw new Error("Error API");
                const lista = await res.json();
                renderizarLista(lista);
            } catch (error) {
                console.error(error);
                grid.innerHTML = '<p class="col-span-full text-center text-red-500">No se pudieron cargar tus publicaciones.</p>';
            }
        }

        function renderizarLista(lista) {
            const grid = document.getElementById('grid-mis-publicaciones');
            grid.innerHTML = ''; // Limpiar spinner

            if(lista.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-white rounded-xl shadow border border-dashed border-gray-300">
                        <i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">No tienes publicaciones activas.</p>
                        <a href="index.html" class="mt-4 inline-block text-orange-600 font-bold hover:underline">Crear un reporte ahora</a>
                    </div>`;
                return;
            }

            lista.forEach(a => {
                const fechaRenov = new Date(a.fechaUltimaRenovacion);
                const hoy = new Date();
                const diasRestantes = 15 - Math.ceil(Math.abs(hoy - fechaRenov) / (1000 * 60 * 60 * 24));
                
                let estadoBadge = '';
                let acciones = '';
                let opacidad = 'opacity-100';

                // --- ESTADO 4: FINALIZADO (HIST√ìRICO) ---
                if (a.idEstado === 4) { 
                    opacidad = 'opacity-60 grayscale';
                    estadoBadge = `<span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold border border-gray-200">üèÅ CASO CERRADO</span>`;
                    acciones = `<button onclick="borrar(${a.id})" class="text-red-500 hover:text-red-700 font-bold text-sm w-full text-center py-2"><i class="fa-solid fa-trash-can mr-2"></i>Eliminar del historial</button>`;
                } 
                // --- ESTADO 2: PERDIDO ---
                else if (a.idEstado === 2) {
                    estadoBadge = `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-200">üî¥ SE BUSCA</span>`;
                    acciones = `
                        <button onclick="finalizar(${a.id}, 2)" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 mb-2 transition shadow-sm">
                            <i class="fa-solid fa-house-user mr-2"></i> ¬°Ya apareci√≥!
                        </button>
                        <div class="flex gap-2">
                            <button onclick="renovar(${a.id})" class="flex-1 bg-orange-50 text-orange-600 py-2 rounded-lg font-bold text-xs hover:bg-orange-100">Renovar (${diasRestantes}d)</button>
                            <button onclick="borrar(${a.id})" class="flex-1 border border-red-200 text-red-500 py-2 rounded-lg font-bold text-xs hover:bg-red-50">Borrar</button>
                        </div>
                    `;
                }
                // --- ESTADO 3: ENCONTRADO (AVISO) ---
                else if (a.idEstado === 3) {
                    estadoBadge = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">üü¢ BUSCO DUE√ëO</span>`;
                    acciones = `
                        <button onclick="finalizar(${a.id}, 3)" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 mb-2 transition shadow-sm">
                            <i class="fa-solid fa-handshake mr-2"></i> Entregado a familia
                        </button>
                        <div class="flex gap-2">
                            <button onclick="renovar(${a.id})" class="flex-1 bg-orange-50 text-orange-600 py-2 rounded-lg font-bold text-xs hover:bg-orange-100">Renovar (${diasRestantes}d)</button>
                            <button onclick="borrar(${a.id})" class="flex-1 border border-red-200 text-red-500 py-2 rounded-lg font-bold text-xs hover:bg-red-50">Borrar</button>
                        </div>
                    `;
                }
                // --- ESTADO 1: ADOPCI√ìN ---
                else {
                    estadoBadge = `<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">üè° EN ADOPCI√ìN</span>`;
                    acciones = `
                        <button onclick="finalizar(${a.id}, 1)" class="w-full bg-blue-500 text-white py-2 rounded-lg font-bold hover:bg-blue-600 mb-2 transition shadow-sm">
                            <i class="fa-solid fa-check mr-2"></i> ¬°Adoptado!
                        </button>
                        <button onclick="borrar(${a.id})" class="w-full border border-red-200 text-red-500 py-2 rounded-lg font-bold hover:bg-red-50 transition text-sm">Eliminar</button>
                    `;
                }

                grid.innerHTML += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col ${opacidad} transition-all hover:shadow-md">
                        <div class="relative h-48 group">
                            <img src="${a.imagenUrl || 'https://via.placeholder.com/400'}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                            <div class="absolute top-3 right-3 shadow-sm">${estadoBadge}</div>
                        </div>
                        <div class="p-5 flex-1 flex flex-col">
                            <h3 class="text-lg font-bold text-gray-800 mb-1">${a.nombre}</h3>
                            <p class="text-xs text-gray-500 mb-3 flex items-center">
                                <i class="fa-regular fa-calendar mr-1"></i> ${new Date(a.fechaPublicacion).toLocaleDateString()}
                            </p>
                            <p class="text-sm text-gray-600 mb-4 flex-1 line-clamp-2">${a.descripcion}</p>
                            
                            <div class="mt-auto border-t border-gray-100 pt-4">
                                ${acciones}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ... (Aqu√≠ van tus funciones finalizar, renovar y borrar que ya ten√≠as) ...
        async function finalizar(id, estadoOrigen) {
            const nuevoEstado = 4;
            
            let tituloConfirm = "¬øCaso Resuelto?";
            let textoConfirm = "";
            let textoHistoria = "";
            let tituloHistoria = "";

            if (estadoOrigen === 2) {
                textoConfirm = "¬°Qu√© alegr√≠a! Se marcar√° como encontrado y desaparecer√° del mapa p√∫blico.";
                tituloHistoria = "üéâ ¬°Final Feliz!";
                textoHistoria = "¬øTe gustar√≠a contar c√≥mo fue el reencuentro en la Comunidad para sumar puntos?";
            } else if (estadoOrigen === 3) {
                textoConfirm = "El aviso dejar√° de ser visible en el mapa.";
                tituloHistoria = "üëè ¬°Gran trabajo!";
                textoHistoria = "¬øQuieres compartir esta buena acci√≥n en el muro?";
            } else {
                textoConfirm = "¬øSe concret√≥ la adopci√≥n?";
                tituloHistoria = "üè° ¬°Nueva Vida!";
                textoHistoria = "¬øQuieres compartir la adopci√≥n en la comunidad?";
            }

            // 1. PRIMERA CONFIRMACI√ìN (Cambiar Estado)
            const result = await Swal.fire({
                title: tituloConfirm,
                text: textoConfirm,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#22c55e', // Green
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, confirmar',
                cancelButtonText: 'Cancelar'
            });

            if(!result.isConfirmed) return;

            try {
                const res = await fetch(`${API_URL}/Animales/estado/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(nuevoEstado)
                });
                
                if(res.ok) {
                    // 2. SEGUNDA CONFIRMACI√ìN (Compartir Historia)
                    const shareResult = await Swal.fire({
                        title: tituloHistoria,
                        text: textoHistoria,
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonColor: '#f97316',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'S√≠, compartir',
                        cancelButtonText: 'No, gracias'
                    });

                    if (shareResult.isConfirmed) {
                        window.location.href = 'comunidad.html?modo=historia';
                    } else {
                        cargarMisPublicaciones();
                    }
                }
            } catch(e) { console.error(e); }
        }

        async function renovar(id) {
            const result = await Swal.fire({
                title: '¬øRenovar publicaci√≥n?',
                text: "Tu aviso estar√° visible por 15 d√≠as m√°s.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316',
                confirmButtonText: 'S√≠, renovar'
            });

            if(result.isConfirmed) {
                await fetch(`${API_URL}/Animales/renovar/${id}`, { method: 'PUT' });
                Swal.fire('Renovado', 'Tu publicaci√≥n est√° activa nuevamente.', 'success');
                cargarMisPublicaciones();
            }
        }

        async function borrar(id) {
            const result = await Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "Esta acci√≥n eliminar√° el registro permanentemente.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if(result.isConfirmed) {
                await fetch(`${API_URL}/Animales/${id}`, { method: 'DELETE' });
                Swal.fire('Eliminado', 'El registro ha sido borrado.', 'success');
                cargarMisPublicaciones();
            }
        }

        async function borrar(id) {
            if(!confirm("¬øEliminar?")) return;
            await fetch(`${API_URL}/Animales/${id}`, { method: 'DELETE' });
            cargarMisPublicaciones();
        }
    </script>
</body>
</html>